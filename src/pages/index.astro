---
import Layout from "@/layouts/Layout.astro";
import { getCollection } from "astro:content";
import { isValidDate, fmt } from "@/lib/date";
import HeroRotator from "@/components/HeroRotator.astro";
import ContentCard from "@/components/ContentCard.astro";

// Helpers
const safeDate = (d: unknown) => (typeof d === "string" && isValidDate(d) ? fmt(d) : null);
const safeCat = (c: unknown) => (typeof c === "string" && c.trim().length ? c.trim() : "General");
const safeSlug = (s: unknown) => (typeof s === "string" ? s : "");

// All guides and posts for featured section
const allGuides = await getCollection("guides", ({ data }) => data?.draft !== true);
const allPosts = await getCollection("posts", ({ data }) => data?.draft !== true);

// Featured secondary entries (deterministic sort: weight desc, date desc, title asc)
const secondaryGuides = allGuides.filter(
  (g) => g.data.featured === true && g.data.featureTier === "secondary"
);
const secondaryPosts = allPosts.filter(
  (p) => p.data.featured === true && p.data.featureTier === "secondary"
);

let featuredSecondary = [...secondaryGuides, ...secondaryPosts].sort((a, b) => {
  const weightA = a.data.rotationWeight ?? 0;
  const weightB = b.data.rotationWeight ?? 0;
  if (weightB !== weightA) return weightB - weightA;

  const dateA = new Date(a.data?.updatedDate ?? a.data?.publishDate ?? 0).valueOf();
  const dateB = new Date(b.data?.updatedDate ?? b.data?.publishDate ?? 0).valueOf();
  if (dateB !== dateA) return dateB - dateA;

  return (a.data?.title ?? "").localeCompare(b.data?.title ?? "");
});

// Fallback if not enough secondary featured: fill with recent non-featured content
const targetCount = 6;
if (featuredSecondary.length < targetCount) {
  const featuredIds = new Set(featuredSecondary.map((e) => e.id));
  const nonFeatured = [...allGuides, ...allPosts]
    .filter((e) => !featuredIds.has(e.id) && e.data.category !== "Guide Hubs")
    .sort((a, b) => {
      const dateA = new Date(a.data?.updatedDate ?? a.data?.publishDate ?? 0).valueOf();
      const dateB = new Date(b.data?.updatedDate ?? b.data?.publishDate ?? 0).valueOf();
      if (dateB !== dateA) return dateB - dateA;
      return (a.data?.title ?? "").localeCompare(b.data?.title ?? "");
    });
  featuredSecondary = [...featuredSecondary, ...nonFeatured].slice(0, targetCount);
}

const displayFeatured = featuredSecondary.slice(0, targetCount);
const guideIds = new Set(allGuides.map((g) => g.id));
function getEntryType(entry: typeof displayFeatured[0]): "post" | "guide" {
  return guideIds.has(entry.id) ? "guide" : "post";
}

// Guides: exclude drafts + Guide Hubs, sort newest first
const guides = allGuides
  .filter((g) => g.data?.category !== "Guide Hubs")
  .sort((a, b) => {
    const dateA = new Date(a.data?.updatedDate ?? a.data?.publishDate ?? 0).valueOf();
    const dateB = new Date(b.data?.updatedDate ?? b.data?.publishDate ?? 0).valueOf();
    if (dateB !== dateA) return dateB - dateA;
    return (a.data?.title ?? "").localeCompare(b.data?.title ?? "");
  });

// Posts: exclude drafts, newest first, latest 5
const posts = allPosts
  .sort((a, b) => {
    const dateA = new Date(a.data?.updatedDate ?? a.data?.publishDate ?? 0).valueOf();
    const dateB = new Date(b.data?.updatedDate ?? b.data?.publishDate ?? 0).valueOf();
    if (dateB !== dateA) return dateB - dateA;
    return (a.data?.title ?? "").localeCompare(b.data?.title ?? "");
  })
  .slice(0, 5);

// Page meta
const frontmatter = {
  title: "Patient Guide — Clear, practical health guides",
  description: "Clear, practical health guides — no fluff.",
};
---

<Layout {frontmatter}>
  <!-- Hero Rotator -->
  <HeroRotator />

  <!-- Hero text -->
  <section class="py-6">
    <h1 class="text-4xl font-bold mb-3">Patient Guide</h1>
    <p class="text-lg text-gray-700 mb-5">
      Clear, practical health guides — no fluff. Evidence-based content on metabolic health,
      chronic disease, and everyday decisions.
    </p>

    <!-- Single primary CTA -->
    <a
      href="/guides"
      class="inline-block px-4 py-2 rounded-lg font-semibold text-white bg-gray-900 hover:bg-gray-800 border border-transparent"
    >
      Browse Guides
    </a>
  </section>

  <!-- Featured Section -->
  {displayFeatured.length > 0 && (
    <section class="mt-8">
      <h2 class="text-2xl font-semibold mb-4">Featured</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {displayFeatured.map((entry) => (
          <ContentCard entry={entry} type={getEntryType(entry)} />
        ))}
      </div>
    </section>
  )}

  <!-- Latest posts -->
  <section class="mt-12">
    <h2 class="text-2xl font-semibold mb-4">Latest posts</h2>
    {posts.length === 0 ? (
      <p>No posts yet.</p>
    ) : (
      <ul class="divide-y divide-gray-200 bg-white rounded-2xl shadow">
        {posts.map((p) => {
          const href = `/posts/${safeSlug(p.slug)}`;
          const title = p.data?.title ?? "(Untitled)";
          const desc = p.data?.description ?? "";
          const date = safeDate(p.data?.updatedDate ?? p.data?.publishDate);
          return (
            <li class="p-5">
              <a href={href} class="text-lg font-medium hover:underline">
                {title}
              </a>
              {date && (
                <span class="ml-2 text-xs text-gray-500 align-middle">
                  {date}
                </span>
              )}
              {desc && <p class="text-sm text-gray-600 mt-1">{desc}</p>}
            </li>
          );
        })}
      </ul>
    )}

    <!-- Browse all posts CTA -->
    <p class="mt-6">
      <a href="/posts/" class="inline-block px-3 py-2 rounded-lg border hover:bg-gray-50">
        Browse all posts →
      </a>
    </p>
  </section>

  <!-- Latest Guides (top 12 by date) -->
  <section class="mt-12">
    <h2 class="text-2xl font-semibold mb-4">Latest Guides</h2>

    {guides.length === 0 ? (
      <p>No guides yet.</p>
    ) : (
      <ul class="divide-y divide-gray-200 bg-white rounded-2xl shadow">
        {guides.slice(0, 12).map((e) => {
          const href = `/guides/${safeSlug(e.slug)}`;
          const title = e.data?.title ?? "(Untitled)";
          const desc = e.data?.description ?? "";
          const cat = safeCat(e.data?.category);
          const rawDate = e.data?.updatedDate ?? e.data?.publishDate;
          const prettyDate = safeDate(rawDate);
          const dateLabel = e.data?.updatedDate ? "Updated" : "Published";

          return (
            <li class="p-5">
              <a href={href} class="text-lg font-medium hover:underline">
                {title}
              </a>
              {cat && (
                <span class="ml-2 text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-600 align-middle">
                  {cat}
                </span>
              )}
              {prettyDate && (
                <span class="ml-2 text-xs text-gray-500 align-middle">
                  {dateLabel} {prettyDate}
                </span>
              )}
              {desc && <p class="text-sm text-gray-600 mt-1">{desc}</p>}
            </li>
          );
        })}
      </ul>
    )}

    <!-- Browse all guides CTA -->
    <p class="mt-6">
      <a href="/guides/" class="inline-block px-3 py-2 rounded-lg border hover:bg-gray-50">
        Browse all guides →
      </a>
    </p>
  </section>
</Layout>
