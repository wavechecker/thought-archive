---
import Layout from "@/layouts/Layout.astro";
import { getCollection } from "astro:content";

const all = await getCollection("guides");
const norm = (s) => (s ?? "").toLowerCase();

const isT1D = (e) => {
  const cat = norm(e.data?.category);
  const tags = (e.data?.tags ?? []).map(norm);
  return (
    cat === "type 1 diabetes" ||
    tags.includes("type 1 diabetes") ||
    tags.includes("t1d") ||
    tags.includes("diabetes")
  );
};

const items = all
  .filter((e) => !e.data?.draft)
  .filter(isT1D)
  .sort((a, b) => new Date(b.data?.publishDate ?? 0) - new Date(a.data?.publishDate ?? 0));

// Build links directly from the collection slug, NO manual category prefixing
const linkFor = (e) => `/guides/${e.slug}/`;
---

<Layout frontmatter={{ title: "Type 1 Diabetes — Guide Hub", description: "Browse patient-friendly guides for Type 1 Diabetes." }}>
  <h1>Type 1 Diabetes — Guide Hub</h1>
  <p>Browse patient-friendly guides for Type 1 Diabetes.</p>

  {items.length === 0 ? (
    <p>No guides found. Check category/tags and draft flags.</p>
  ) : (
    <ul>
      {items.map((g) => (
        <li>
          <a href={linkFor(g)}>{g.data.title}</a>
          {g.data?.description && <> — {g.data.description}</>}
        </li>
      ))}
    </ul>
  )}
</Layout>
