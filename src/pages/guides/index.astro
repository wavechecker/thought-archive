---
import Layout from "@/layouts/Layout.astro";
import { getCollection } from "astro:content";
import { fmt, isValidDate } from "@/lib/date.ts";
import {
  slugifyCategory,
  CATEGORY_ORDER,
  CATEGORY_DESCRIPTIONS,
} from "@/lib/slug.ts";

// Redirect legacy links like /guides/?category=Emergencies → /guides/category/emergencies
const q = Astro.url.searchParams.get("category");
if (q) {
  return Astro.redirect(`/guides/category/${slugifyCategory(q)}`, 301);
}

// Load all published guides
const guides = await getCollection("guides", ({ data }) => data?.draft !== true);

// Featured guides
const FEATURED = [
  {
    slug: "childhood-obesity-prevention",
    title: "Childhood Obesity Prevention",
    blurb: "Causes, risks, and proven strategies for prevention at home, in schools, and through public policy."
  },
  {
    slug: "healthy-diets-for-children",
    title: "Healthy Diets for Children",
    blurb: "Food groups, portion sizes, and simple strategies families can use to build healthier eating habits."
  },
  {
    slug: "diabetes-children",
    title: "Diabetes in Children",
    blurb: "Symptoms, diagnosis, treatment, and prevention — helping families and schools support affected children."
  }
];

// Map: slug -> entry (only if present)
const bySlug = new Map(guides.map((e) => [e.slug, e]));
const featuredEntries = FEATURED
  .map((f) => {
    const entry = bySlug.get(f.slug);
    return entry ? { ...f, href: `/guides/${entry.slug}` } : null;
  })
  .filter(Boolean);

// Build map: category -> guides
// Exclude hub/overview pages (category "Guide Hubs") from counts
const byCategory = new Map<string, typeof guides>();
for (const e of guides) {
  // Skip hub pages to avoid inflating category counts
  if (typeof e.data?.category === "string" && e.data.category.trim() === "Guide Hubs") {
    continue;
  }
  const cat = (e.data.category ?? "General Health").trim();
  if (!byCategory.has(cat)) byCategory.set(cat, []);
  byCategory.get(cat)!.push(e);
}

// Order categories by preferred list, then alpha for any extras
const categories = Array.from(byCategory.keys()).sort((a, b) => {
  const ia = CATEGORY_ORDER.indexOf(a);
  const ib = CATEGORY_ORDER.indexOf(b);
  if (ia === -1 && ib === -1) return a.localeCompare(b);
  if (ia === -1) return 1;
  if (ib === -1) return -1;
  return ia - ib;
});

const MAX_VISIBLE = 5;

// Optional overrides: point some categories to a hub page
const overrides: Record<string, string> = {
  "Mental Health": "/guides/mental-health",
  // Add more when ready:
  // "Child & Adolescent Health": "/guides/child-and-adolescent-health",
  // "Vaccination": "/guides/vaccination",
  // "Emergencies": "/guides/emergencies",
};

const frontmatter = {
  title: "Health Guides — PatientGuide.io",
  description: "Browse our library of evidence-based health guides organized by category.",
};
---

<Layout {frontmatter}>
  <div class="pg-page-header">
    <h1 class="pg-page-header__title">Health Guides</h1>
    <p class="pg-page-header__subtitle">
      Explore our library of evidence-based guides, organized by category.
    </p>
  </div>

  {featuredEntries.length > 0 && (
    <section class="pg-section">
      <div class="pg-section__header">
        <h2 class="pg-section__title">Featured: Child & Adolescent Health</h2>
      </div>
      <div class="pg-card-grid">
        {featuredEntries.map((f) => (
          <article class="pg-card pg-card--interactive">
            <h3 class="pg-card__title">
              <a href={f!.href} class="pg-card__link">{f!.title}</a>
            </h3>
            <p class="pg-card__description">{f!.blurb}</p>
          </article>
        ))}
      </div>
    </section>
  )}

  <section class="pg-section">
    <div class="pg-section__header">
      <h2 class="pg-section__title">Browse by Category</h2>
    </div>

    <div class="pg-category-grid">
      {categories.map((cat) => {
        const list = byCategory.get(cat)!;
        const count = list.length;

        const defaultHref = `/guides/category/${slugifyCategory(cat)}`;
        const catHref = overrides[cat] ?? defaultHref;

        const sorted = list
          .slice()
          .sort(
            (a, b) =>
              +new Date((b.data.updatedDate ?? b.data.publishDate) as any) -
              +new Date((a.data.updatedDate ?? a.data.publishDate) as any)
          );

        const visible = sorted.slice(0, MAX_VISIBLE);
        const hidden = sorted.slice(MAX_VISIBLE);

        return (
          <article class="pg-category-card">
            <div class="pg-category-card__header">
              <h3 class="pg-category-card__title">
                <a href={catHref}>{cat}</a>
              </h3>
              <span class="pg-category-card__count">{count} guide{count === 1 ? "" : "s"}</span>
            </div>
            <p class="pg-category-card__description">
              {CATEGORY_DESCRIPTIONS[cat] ?? "Browse guides in this topic."}
            </p>

            <ul class="pg-category-card__list">
              {visible.map((e) => {
                const href = `/guides/${e.slug}`;
                const title = e.data.title ?? "(Untitled)";
                const d = e.data.updatedDate ?? e.data.publishDate;
                return (
                  <li>
                    <a href={href}>{title}</a>
                    {isValidDate(d) && <time class="pg-category-card__date">{fmt(d)}</time>}
                  </li>
                );
              })}
            </ul>

            {hidden.length > 0 && (
              <details class="pg-category-card__more">
                <summary>Show {hidden.length} more</summary>
                <ul class="pg-category-card__list">
                  {hidden.map((e) => {
                    const href = `/guides/${e.slug}`;
                    const title = e.data.title ?? "(Untitled)";
                    const d = e.data.updatedDate ?? e.data.publishDate;
                    return (
                      <li>
                        <a href={href}>{title}</a>
                        {isValidDate(d) && <time class="pg-category-card__date">{fmt(d)}</time>}
                      </li>
                    );
                  })}
                </ul>
              </details>
            )}
          </article>
        );
      })}
    </div>
  </section>
</Layout>

<style>
  .pg-page-header {
    margin-bottom: var(--pg-space-8);
  }

  .pg-page-header__title {
    font-size: var(--pg-text-3xl);
    font-weight: 700;
    color: var(--pg-text);
    margin: 0 0 var(--pg-space-2);
  }

  .pg-page-header__subtitle {
    font-size: var(--pg-text-lg);
    color: var(--pg-text-muted);
    margin: 0;
  }

  .pg-section {
    margin-top: var(--pg-space-10);
  }

  .pg-section__header {
    margin-bottom: var(--pg-space-5);
  }

  .pg-section__title {
    font-size: var(--pg-text-xl);
    font-weight: 600;
    color: var(--pg-text);
    margin: 0;
  }

  /* Card grid for featured */
  .pg-card-grid {
    display: grid;
    gap: var(--pg-space-4);
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  }

  .pg-card__link {
    color: inherit;
    text-decoration: none;
  }

  .pg-card__link::after {
    content: "";
    position: absolute;
    inset: 0;
  }

  .pg-card {
    position: relative;
  }

  /* Category grid */
  .pg-category-grid {
    display: grid;
    gap: var(--pg-space-4);
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  }

  .pg-category-card {
    background: var(--pg-surface);
    border: 1px solid var(--pg-border);
    border-radius: var(--pg-radius-xl);
    padding: var(--pg-space-5);
    transition: border-color var(--pg-transition-fast), box-shadow var(--pg-transition-fast);
  }

  .pg-category-card:hover {
    border-color: var(--pg-border-muted);
    box-shadow: var(--pg-shadow-sm);
  }

  .pg-category-card__header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: var(--pg-space-2);
    margin-bottom: var(--pg-space-2);
  }

  .pg-category-card__title {
    font-size: var(--pg-text-lg);
    font-weight: 600;
    margin: 0;
  }

  .pg-category-card__title a {
    color: var(--pg-text);
    text-decoration: none;
  }

  .pg-category-card__title a:hover {
    color: var(--pg-link);
    text-decoration: underline;
  }

  .pg-category-card__count {
    font-size: var(--pg-text-xs);
    color: var(--pg-text-muted);
    white-space: nowrap;
  }

  .pg-category-card__description {
    font-size: var(--pg-text-sm);
    color: var(--pg-text-soft);
    margin: 0 0 var(--pg-space-4);
    line-height: var(--pg-leading-relaxed);
  }

  .pg-category-card__list {
    margin: 0;
    padding-left: var(--pg-space-5);
    font-size: var(--pg-text-sm);
  }

  .pg-category-card__list li {
    margin-bottom: var(--pg-space-2);
    line-height: var(--pg-leading-snug);
  }

  .pg-category-card__list a {
    color: var(--pg-link);
  }

  .pg-category-card__date {
    color: var(--pg-text-muted);
    font-size: var(--pg-text-xs);
    margin-left: var(--pg-space-2);
  }

  .pg-category-card__more {
    margin-top: var(--pg-space-3);
  }

  .pg-category-card__more summary {
    font-size: var(--pg-text-sm);
    color: var(--pg-link);
    cursor: pointer;
  }

  .pg-category-card__more summary:hover {
    text-decoration: underline;
  }

  .pg-category-card__more .pg-category-card__list {
    margin-top: var(--pg-space-3);
  }
</style>
