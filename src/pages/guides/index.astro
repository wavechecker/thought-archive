---
import { getCollection } from "astro:content";
import { fmt, isValidDate } from "@/lib/date.ts";
import {
  slugifyCategory,
  CATEGORY_ORDER,
  CATEGORY_DESCRIPTIONS,
} from "@/lib/slug.ts";

// Redirect legacy links like /guides/?category=Emergencies → /guides/category/emergencies
const q = Astro.url.searchParams.get("category");
if (q) {
  return Astro.redirect(`/guides/category/${slugifyCategory(q)}`, 301);
}

// Load all published guides
const guides = await getCollection("guides", ({ data }) => data?.draft !== true);

// ---- Featured row (kept as-is, optional) ----
const FEATURED = [
  {
    slug: "childhood-obesity-prevention",
    title: "Childhood Obesity Prevention",
    blurb:
      "Childhood obesity has now surpassed underweight globally. This guide explains causes, risks, and proven strategies for prevention at home, in schools, and via policy."
  },
  {
    slug: "healthy-diets-for-children",
    title: "Healthy Diets for Children",
    blurb:
      "Balanced nutrition is key to children’s growth, learning, and long-term health. Practical strategies for families and schools."
  },
  {
    slug: "diabetes-children",
    title: "Diabetes in Children and Adolescents",
    blurb:
      "Type 1 remains common; type 2 is rising. Symptoms, diagnosis, treatment, and prevention — for families and schools."
  }
];

// Map: slug -> entry (only if present)
const bySlug = new Map(guides.map((e) => [e.slug, e]));
const featuredEntries = FEATURED
  .map((f) => {
    const entry = bySlug.get(f.slug);
    return entry ? { ...f, href: `/guides/${entry.slug}` } : null;
  })
  .filter(Boolean);

// ---- Build map: category -> guides ----
const byCategory = new Map<string, typeof guides>();
for (const e of guides) {
  const cat = (e.data.category ?? "General Health").trim();
  if (!byCategory.has(cat)) byCategory.set(cat, []);
  byCategory.get(cat)!.push(e);
}

// Order categories by preferred list, then alpha for any extras
const categories = Array.from(byCategory.keys()).sort((a, b) => {
  const ia = CATEGORY_ORDER.indexOf(a);
  const ib = CATEGORY_ORDER.indexOf(b);
  if (ia === -1 && ib === -1) return a.localeCompare(b);
  if (ia === -1) return 1;
  if (ib === -1) return -1;
  return ia - ib;
});

const MAX_VISIBLE = 5;

// Optional overrides: point some categories to a hub page
const overrides: Record<string, string> = {
  // "Vaccination": "/guides/vaccination-guide-hub",
  // "Emergencies": "/guides/emergencies-guide-hub",
  // "Child & Adolescent Health": "/guides/child-adolescent-health-hub",
};
---

<!-- Hero featuring the Mental Health Toolkit -->
<section class="hero">
  <div class="hero-inner">
    <div>
      <h1>Guides</h1>
      <p class="tagline">
        Explore our library of health guides, organized by category.
        Start with our <strong>Mental Health Toolkit</strong>—evidence-based habits that
        support mood and resilience alongside therapy or medication.
      </p>

      <div class="cta-row">
        <a href="/guides/mental-health-toolkit" class="btn btn-primary">Open Mental Health Toolkit</a>
        <a href="/guides/mental-health" class="btn btn-ghost">Browse Mental Health Hub</a>
      </div>
    </div>
  </div>
</section>

{featuredEntries.length > 0 && (
  <>
    <h2 class="section-title">Featured: Child &amp; Adolescent Health</h2>
    <div class="cards">
      {featuredEntries.map((f) => (
        <article class="card">
          <h3><a href={f!.href}>{f!.title}</a></h3>
          <p>{f!.blurb}</p>
        </article>
      ))}
    </div>
  </>
)}

<ul class="grid">
  {categories.map((cat) => {
    const list = byCategory.get(cat)!;
    const count = list.length;

    const defaultHref = `/guides/category/${slugifyCategory(cat)}`;
    const catHref = overrides[cat] ?? defaultHref;

    const sorted = list
      .slice()
      .sort(
        (a, b) =>
          +new Date((b.data.updatedDate ?? b.data.publishDate) as any) -
          +new Date((a.data.updatedDate ?? a.data.publishDate) as any)
      );

    const visible = sorted.slice(0, MAX_VISIBLE);
    const hidden = sorted.slice(MAX_VISIBLE);

    return (
      <li class="cat-card">
        <h3><a href={catHref}>{cat}</a></h3>
        <p>{CATEGORY_DESCRIPTIONS[cat] ?? "Browse guides in this topic."}</p>
        <small>{count} guide{count === 1 ? "" : "s"}</small>

        <ul class="mini">
          {visible.map((e) => {
            const href = `/guides/${e.slug}`;
            const title = e.data.title ?? "(Untitled)";
            const d = e.data.updatedDate ?? e.data.publishDate;
            return (
              <li>
                <a href={href}>{title}</a>
                {isValidDate(d) && <span class="date"> {fmt(d)}</span>}
              </li>
            );
          })}
        </ul>

        {hidden.length > 0 && (
          <details class="more">
            <summary>Show {hidden.length} more</summary>
            <ul class="mini">
              {hidden.map((e) => {
                const href = `/guides/${e.slug}`;
                const title = e.data.title ?? "(Untitled)";
                const d = e.data.updatedDate ?? e.data.publishDate;
                return (
                  <li>
                    <a href={href}>{title}</a>
                    {isValidDate(d) && <span class="date"> {fmt(d)}</span>}
                  </li>
                );
              })}
            </ul>
          </details>
        )}
      </li>
    );
  })}
</ul>

<style>
  .hero {
    margin-block: .25rem 1.25rem;
  }
  .hero-inner {
    border: 1px solid var(--astro-border, #e5e7eb);
    border-radius: 16px;
    background: linear-gradient(180deg, #ffffff, #fafafa);
    padding: 1.25rem;
  }
  .hero h1 {
    font-size: 2rem;
    line-height: 1.2;
    margin: 0 0 .35rem;
    font-weight: 700;
  }
  .tagline {
    color: #374151;
    margin: 0 0 .9rem;
  }
  .cta-row {
    display: flex;
    gap: .6rem;
    flex-wrap: wrap;
  }
  .btn {
    display: inline-block;
    padding: .55rem .9rem;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
    text-decoration: none;
    font-weight: 600;
  }
  .btn-primary {
    background: #111827;
    color: #fff;
    border-color: #111827;
  }
  .btn-primary:hover { background:#0f172a; border-color:#0f172a; }
  .btn-ghost:hover { background:#f3f4f6; }

  .section-title { margin: 1.25rem 0 .5rem; font-size: 1.25rem; font-weight: 700; }

  .cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 1.25rem;
    margin-block: .5rem 1.5rem;
  }
  .card {
    padding: 1rem;
    border: 1px solid var(--astro-border, #e5e7eb);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    background: white;
  }
  .grid {
    display:grid;
    gap:1rem;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    margin-top: .75rem;
  }
  .cat-card {
    padding:1rem;
    border:1px solid var(--astro-border, #e5e7eb);
    border-radius:12px;
    background: white;
  }
  .mini { margin-top:.5rem; padding-left:1rem; }
  .mini li { list-style: disc; }
  .date { color:#6b7280; font-size:.85em; margin-left:.35rem; }
  details.more { margin-top:.5rem; }
  details.more summary { cursor:pointer; text-decoration: underline; }
</style>
