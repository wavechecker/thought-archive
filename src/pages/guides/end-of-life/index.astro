---
import Layout from "@/layouts/Layout.astro";
import { getCollection } from "astro:content";

const site = Astro.site?.toString().replace(/\/+$/, "") || "https://patientguide.io";
const pageUrl = `${site}/guides/end-of-life`;

const title = "End of Life — Guides";
const description =
  "Palliative care, symptom control, advance directives, hospice, caregiver support, and what to expect.";

const guides = await getCollection("guides", ({ data }) =>
  data?.draft !== true && (
    data?.category === "End of Life" ||
    data?.category === "end of life" ||
    data?.category === "Palliative Care" ||   // include common variant if used
    data?.category === "Palliative"           // include common variant if used
  )
);

const breadcrumbLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Guides", item: `${site}/guides` },
    { "@type": "ListItem", position: 2, name: "End of Life", item: pageUrl }
  ]
};

const collectionPageLd = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  name: title,
  description,
  url: pageUrl,
  inLanguage: "en",
  isPartOf: { "@type": "WebSite", name: "patientguide.io", url: site }
};
---

<Layout title={title} description={description}>
  <section class="prose max-w-3xl mx-auto py-8">
    <h1>{title}</h1>
    <p>{description}</p>

    {guides.length === 0 ? (
      <p>No guides found yet.</p>
    ) : (
      <ul class="list-disc list-inside mt-6 space-y-2">
        {guides.map((g) => (
          <li>
            <a href={`/guides/${g.slug}`}>{g.data?.title ?? "(Untitled)"}</a>
            {g.data?.description && <small> — {g.data.description}</small>}
          </li>
        ))}
      </ul>
    )}
  </section>

  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbLd)} />
  <script type="application/ld+json" set:html={JSON.stringify(collectionPageLd)} />
</Layout>
