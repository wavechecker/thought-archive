---
import { getCollection, getEntryBySlug } from "astro:content";
import { isValidDate } from "@/lib/date";

// ✅ MDX components (retroactive for ALL guides)
import StratBox from "@/components/StratBox.astro";
import EvidenceBox from "@/components/EvidenceBox.astro";

export const prerender = true;

// Static paths from collection (skip drafts)
export async function getStaticPaths() {
  const entries = await getCollection("guides", ({ data }) => data?.draft !== true);
  return entries.map((e) => ({ params: { slug: e.slug } }));
}

// Resolve slug param
const slugParam = Astro.params.slug;
const slug = Array.isArray(slugParam) ? slugParam.join("/") : (slugParam ?? "");
if (!slug) return Astro.redirect("/404");

const entry = await getEntryBySlug("guides", slug);
if (!entry || entry.data?.draft === true) return Astro.redirect("/404");

// ✅ Provide MDX components here (THIS WAS MISSING)
const mdxComponents = { StratBox, EvidenceBox };
const { Content } = await entry.render({ components: mdxComponents });

const data = entry.data;

// Site + canonical
const site = Astro.site?.toString().replace(/\/+$/, "") || "https://patientguide.io";
const canonicalUrl = `${site}/guides/${entry.slug}`;

// Dates
const pub = isValidDate?.(data.publishDate) ? data.publishDate : undefined;
const mod = isValidDate?.(data.updatedDate) ? data.updatedDate : pub;

// Images
const heroLocal = data?.image ?? data?.heroImage ?? "/og-default.png";
const heroAbs = heroLocal.startsWith("http") ? heroLocal : `${site}${heroLocal}`;

// Breadcrumbs
const breadcrumbs = [
  { name: "Guides", url: `${site}/guides` },
  {
    name: data?.category ?? "General",
    url: `${site}/guides/category/${encodeURIComponent(
      (data?.category ?? "general").toLowerCase().replace(/\s+/g, "-")
    )}`
  },
  { name: data?.title ?? "Guide", url: canonicalUrl }
];

// ---------- JSON-LD ----------
const articleLd = {
  "@context": "https://schema.org",
  "@type": ["Article", "WebPage"],
  mainEntityOfPage: { "@type": "WebPage", "@id": canonicalUrl },
  headline: data.title,
  description: data.description ?? "",
  datePublished: pub,
  dateModified: mod,
  author: { "@type": "Organization", name: "patientguide.io", url: site },
  publisher: {
    "@type": "Organization",
    name: "patientguide.io",
    logo: { "@type": "ImageObject", url: `${site}/logo.png` }
  },
  image: heroAbs,
  inLanguage: "en"
};

const breadcrumbLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: breadcrumbs.map((b, i) => ({
    "@type": "ListItem",
    position: i + 1,
    name: b.name,
    item: b.url
  }))
};
---

<head>
  <meta charset="utf-8" />
  <title>{data.title} | patientguide.io</title>
  <meta name="description" content={data.description ?? ""} />
  <link rel="canonical" href={canonicalUrl} />

  <meta property="og:type" content="article" />
  <meta property="og:title" content={data.title} />
  <meta property="og:description" content={data.description ?? ""} />
  <meta property="og:image" content={heroAbs} />

  <script type="application/ld+json" is:inline set:html={JSON.stringify(articleLd)} />
  <script type="application/ld+json" is:inline set:html={JSON.stringify(breadcrumbLd)} />
</head>

<body class="min-h-screen">
  <main class="container mx-auto px-4 py-8">
    <article class="prose lg:prose-lg max-w-none">
      <header class="mb-6">
        <p class="text-xs uppercase tracking-wide text-slate-500">
          {data?.category ?? "Guide"}
        </p>
        <h1 class="mt-1 text-3xl font-semibold">{data?.title}</h1>
        {(pub || mod) && (
          <p class="mt-2 text-sm text-slate-500">
            {pub}{mod && pub !== mod ? ` • Updated ${mod}` : ""}
          </p>
        )}
        <img
          src={heroLocal}
          alt={data?.title}
          class="mt-4 aspect-[1200/630] w-full rounded-xl object-cover"
          loading="lazy"
        />
      </header>

      <Content />
    </article>
  </main>
</body>
