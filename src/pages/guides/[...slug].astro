---
import { getCollection, getEntryBySlug } from "astro:content";
import { mdxComponents } from "@/lib/mdx-components";
import MdxNull from "@/components/MdxNull.astro";

export const prerender = true;

export async function getStaticPaths() {
  const entries = await getCollection("guides", ({ data }) => data?.draft !== true);

  // IMPORTANT: params.slug must be a primitive string/number
  return entries.map((e) => ({
    params: { slug: String(e.slug) },
  }));
}

const slug = typeof Astro.params.slug === "string" ? Astro.params.slug : "";
if (!slug) return Astro.redirect("/404");

const entry = await getEntryBySlug("guides", slug);
if (!entry || entry.data?.draft === true) return Astro.redirect("/404");

// âœ… CRITICAL FIX:
// Provide known MDX components + a fallback for any unknown component tag.
// This prevents `_missingMdxReference` from crashing your build.
const components = new Proxy(mdxComponents as Record<string, any>, {
  get(target, prop) {
    if (typeof prop === "string" && prop in target) return target[prop];
    return MdxNull;
  },
});

const { Content } = await entry.render({ components });

const data = entry.data;
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{data?.title ?? "Guide"} | patientguide.io</title>
    {data?.description && <meta name="description" content={data.description} />}
  </head>

  <body>
    <main class="container mx-auto px-4 py-8">
      <article class="prose lg:prose-lg max-w-none">
        <h1>{data?.title ?? "Untitled"}</h1>
        {data?.description && <p class="lead">{data.description}</p>}
        <Content />
      </article>
    </main>
  </body>
</html>
