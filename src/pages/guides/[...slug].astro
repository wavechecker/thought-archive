---
import { getCollection, getEntryBySlug } from "astro:content";

// IMPORTANT: use RELATIVE imports (no @/ aliases) to remove build/env ambiguity
import EvidenceBox from "../../components/EvidenceBox.astro";
import StratBox from "../../components/StratBox.astro";

export const prerender = true;

export async function getStaticPaths() {
  const entries = await getCollection("guides", ({ data }) => data?.draft !== true);

  return entries.map((e) => ({
    // Force primitive string to satisfy Astro validator
    params: { slug: String(e.slug) },
  }));
}

const slug = typeof Astro.params.slug === "string" ? Astro.params.slug : "";
if (!slug) return Astro.redirect("/404");

const entry = await getEntryBySlug("guides", slug);
if (!entry || entry.data?.draft === true) return Astro.redirect("/404");

// âœ… PASS COMPONENTS DIRECTLY (no shared file, no proxy)
const { Content } = await entry.render({
  components: {
    EvidenceBox,
    StratBox,
  },
});

const data = entry.data;
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{data?.title ?? "Guide"} | patientguide.io</title>
    {data?.description && <meta name="description" content={data.description} />}
  </head>

  <body>
    <main class="container mx-auto px-4 py-8">
      <article class="prose lg:prose-lg max-w-none">
        <h1>{data?.title ?? "Untitled"}</h1>
        {data?.description && <p class="lead">{data.description}</p>}
        <Content />
      </article>
    </main>
  </body>
</html>
