---
import { getCollection } from "astro:content";
import { render } from "astro:content";

// These are your MDX components (real or shim).
// Make sure these files exist at these paths.
import StratBox from "../../components/StratBox.astro";
import EvidenceBox from "../../components/EvidenceBox.astro";
import MdxNull from "../../components/MdxNull.astro";

// If you have other MDX components used in guides, add them here.
// import OutbreakTracker from "../../components/OutbreakTracker.astro";
// import RiskBox from "../../components/RiskBox.astro";
// etc.

export async function getStaticPaths() {
  const guides = await getCollection("guides");

  return guides.map((entry) => ({
    // IMPORTANT: For [...slug], Astro wants a STRING, not an array.
    // If entry.slug is "foo/bar", this still works.
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;

// Handle runtime safety if Astro.params.slug ever arrives as array in some contexts
const rawSlug = Astro.params.slug;
const slug = Array.isArray(rawSlug) ? rawSlug.join("/") : rawSlug;

const { Content, headings } = await render(entry);

// Prospective + retrospective safety:
// Any unknown MDX component name will render as <MdxNull /> instead of crashing the build.
const mdxComponents = new Proxy(
  {
    StratBox,
    EvidenceBox,
    // OutbreakTracker,
    // RiskBox,
  },
  {
    get(target, prop) {
      if (typeof prop === "string" && prop in target) return target[prop];
      return MdxNull;
    },
  }
);
---

<html lang="en">
  <head>
    <title>{entry.data.title}</title>
    {entry.data.description && <meta name="description" content={entry.data.description} />}
  </head>
  <body>
    <main class="prose dark:prose-invert max-w-3xl mx-auto px-4 py-10">
      <h1>{entry.data.title}</h1>

      {entry.data.publishDate && (
        <p class="text-sm text-gray-500">
          Published: {entry.data.publishDate}
        </p>
      )}

      <Content components={mdxComponents} />

      {/* If you use headings/TOC, keep it; otherwise remove. */}
      {/* <pre>{JSON.stringify(headings, null, 2)}</pre> */}
    </main>
  </body>
</html>
