---
import { getCollection } from "astro:content";

// MDX components used inside guides
import StratBox from "../../components/StratBox.astro";
import EvidenceBox from "../../components/EvidenceBox.astro";
import MdxNull from "../../components/MdxNull.astro";

export async function getStaticPaths() {
  const guides = await getCollection("guides");

  return guides.map((entry) => ({
    // Astro expects a STRING for [...slug]
    // If entry.slug contains "foo/bar", Astro treats it as the catchall path.
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;

// Astro v5+ content rendering
const { Content, headings } = await entry.render();

// Safe fallback: unknown MDX tags become <MdxNull />
const mdxComponents = new Proxy(
  {
    StratBox,
    EvidenceBox,
  },
  {
    get(target, prop) {
      if (typeof prop === "string" && prop in target) return target[prop];
      return MdxNull;
    },
  }
);
---

<html lang="en">
  <head>
    <title>{entry.data.title}</title>
    {entry.data.description && (
      <meta name="description" content={entry.data.description} />
    )}
  </head>

  <body>
    <main class="prose dark:prose-invert max-w-3xl mx-auto px-4 py-10">
      <h1>{entry.data.title}</h1>

      {entry.data.publishDate && (
        <p class="text-sm text-gray-500">Published: {entry.data.publishDate}</p>
      )}

      <Content components={mdxComponents} />

      {/*
        Optional: debugging
        <pre>{JSON.stringify(headings, null, 2)}</pre>
      */}
    </main>
  </body>
</html>
