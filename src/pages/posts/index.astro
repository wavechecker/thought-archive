---
import Layout from "@/layouts/Layout.astro";
import { getCollection } from "astro:content";

// Pull all posts (exclude drafts), newest first
const posts = (await getCollection("posts"))
  .filter((p) => p.data?.draft !== true)
  .sort((a, b) => {
    const da = new Date(a.data?.updatedDate ?? a.data?.publishDate ?? 0).valueOf();
    const db = new Date(b.data?.updatedDate ?? b.data?.publishDate ?? 0).valueOf();
    return db - da || String(a.data?.title).localeCompare(String(b.data?.title));
  });

const frontmatter = {
  title: "Posts — Patient Guide",
  description: "Opinion & analysis — timely takes linked to our evergreen guides.",
};
---

<Layout {frontmatter}>
  <section class="py-10">
    <h1 class="text-4xl font-bold mb-3">Posts</h1>
    <p class="text-lg text-gray-700">
      Opinion & analysis — timely takes that connect to our evergreen guides.
    </p>
  </section>

  <section class="mt-8">
    {posts.length === 0 ? (
      <p>No posts yet.</p>
    ) : (
      <ul class="divide-y divide-gray-200 bg-white rounded-2xl shadow">
        {posts.map((p) => {
          const href = `/posts/${p.slug}/`;
          const title = p.data?.title ?? "(Untitled)";
          const desc = p.data?.description ?? "";
          const date = p.data?.updatedDate ?? p.data?.publishDate;
          return (
            <li class="p-5">
              <a href={href} class="text-lg font-medium hover:underline">{title}</a>
              {date && (
                <span class="ml-2 text-xs text-gray-500 align-middle">
                  {String(date)}
                </span>
              )}
              {desc && <p class="text-sm text-gray-600 mt-1">{desc}</p>}
            </li>
          );
        })}
      </ul>
    )}
  </section>
</Layout>

