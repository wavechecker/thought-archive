---
/**
 * GuideLayout.astro
 * Renders one guide page with SEO + JSON-LD:
 *  - Article/WebPage (always)
 *  - MedicalCondition (if schema.medicalCondition provided)
 *  - FAQPage (if faq array provided)
 *  - BreadcrumbList (Guides → Category → Title)
 */
import { isValidDate } from "@/lib/date.ts";

// Frontmatter props (passed via [...slug].astro)
const {
  title,
  description,
  category,
  publishDate,
  updatedDate,
  tags = [],
  heroImage = "/images/lada-guide-hero.jpg",

  // Optional structured inputs in frontmatter:
  faq = [],                 // [{ q: string, a: string }]
  sameAs = [],             // external canonical refs (WHO, MedlinePlus, etc.)
  breadcrumbs = [],        // optional manual override
  schema = {}              // { medicalCondition: {...} }
} = Astro.props;

// Defensive dates
const pub = isValidDate(publishDate) ? publishDate : undefined;
const mod = isValidDate(updatedDate) ? updatedDate : pub;

// Canonical URL (requires `site` in astro.config)
const site = Astro.site?.toString().replace(/\/+$/, "") ?? "https://patientguide.io";
const canonicalPath = Astro.url.pathname.replace(/\/+$/, "") || "/guides";
const canonicalUrl = `${site}${canonicalPath}`;

// Normalize hero image to absolute for OG/Twitter
const heroAbs = heroImage
  ? (heroImage.startsWith("http") ? heroImage : `${site}${heroImage}`)
  : undefined;

// Default breadcrumbs if not provided
const bc = breadcrumbs.length
  ? breadcrumbs
  : [
      { name: "Guides", url: `${site}/guides` },
      { name: category ?? "General", url: `${site}/guides?category=${encodeURIComponent(category ?? "General")}` },
      { name: title ?? "Guide", url: canonicalUrl },
    ];

/* ------------------------- JSON-LD builders ------------------------- */

// 1) Article/WebPage
const articleLd = {
  "@context": "https://schema.org",
  "@type": ["Article", "WebPage"],
  "mainEntityOfPage": { "@type": "WebPage", "@id": canonicalUrl },
  "headline": title,
  "description": description ?? "",
  "keywords": Array.isArray(tags) && tags.length ? tags : undefined,
  "datePublished": pub ?? undefined,
  "dateModified": mod ?? undefined,
  "author": { "@type": "Organization", "name": "patientguide.io", "url": site },
  "publisher": {
    "@type": "Organization",
    "name": "patientguide.io",
    "logo": { "@type": "ImageObject", "url": `${site}/logo.png` }
  },
  "isPartOf": {
    "@type": "Collection",
    "name": `${category ?? "Guides"} Guides`,
    "url": `${site}/guides?category=${encodeURIComponent(category ?? "General")}`
  },
  "inLanguage": "en",
  "image": heroAbs,
  "about": (title ? { "@type": "Thing", "name": title, "sameAs": sameAs && sameAs.length ? sameAs : undefined } : undefined)
};

// 2) MedicalCondition (only if provided in frontmatter)
function buildMedicalConditionLD(med) {
  if (!med || typeof med !== "object") return null;

  // Map convenience arrays to schema.org structures
  const riskFactor = Array.isArray(med.riskFactors) && med.riskFactors.length
    ? med.riskFactors.map((r) => ({ "@type": "MedicalRiskFactor", "name": r }))
    : undefined;

  const signOrSymptom = Array.isArray(med.symptoms) && med.symptoms.length
    ? med.symptoms.map((s) => ({ "@type": "MedicalSignOrSymptom", "name": s }))
    : undefined;

  // Optional infectious hint if author sets a boolean `contagious`
  const infectiousAgentClass = (typeof med.contagious === "boolean")
    ? (med.contagious ? "Pathogen" : undefined)
    : undefined;

  return {
    "@context": "https://schema.org",
    "@type": "MedicalCondition",
    "name": med.name ?? title,
    "description": med.description ?? description,
    "alternateName": Array.isArray(med.alternateName) && med.alternateName.length ? med.alternateName : undefined,
    "riskFactor": riskFactor,
    "signOrSymptom": signOrSymptom,
    "possibleComplication": Array.isArray(med.possibleComplication) && med.possibleComplication.length ? med.possibleComplication : undefined,
    "infectiousAgentClass": infectiousAgentClass, // only present if contagious === true
    "sameAs": Array.isArray(med.sameAs) && med.sameAs.length ? med.sameAs : undefined,
    "url": canonicalUrl
  };
}

const conditionLd = buildMedicalConditionLD(schema?.medicalCondition);

// 3) FAQPage
const faqLd = Array.isArray(faq) && faq.length
  ? {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": faq.map((item) => ({
        "@type": "Question",
        "name": item.q,
        "acceptedAnswer": { "@type": "Answer", "text": item.a }
      }))
    }
  : null;

// 4) BreadcrumbList
const breadcrumbLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": bc.map((b, i) => ({
    "@type": "ListItem",
    "position": i + 1,
    "name": b.name,
    "item": b.url
  }))
};
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{title} | patientguide.io</title>
    <meta name="description" content={description ?? ""} />
    <link rel="canonical" href={canonicalUrl} />

    <!-- OpenGraph -->
    <meta property="og:type" content="article" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description ?? ""} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:site_name" content="patientguide.io" />
    {heroAbs && <meta property="og:image" content={heroAbs} />}
    {pub && <meta property="article:published_time" content={pub} />}
    {mod && <meta property="article:modified_time" content={mod} />}

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description ?? ""} />
    {heroAbs && <meta name="twitter:image" content={heroAbs} />}
    <meta name="twitter:site" content="@patientguide" />

    <!-- JSON-LD: Article/WebPage -->
    <script type="application/ld+json">
      {JSON.stringify(articleLd)}
    </script>

    <!-- JSON-LD: MedicalCondition (conditional) -->
    {conditionLd && (
      <script type="application/ld+json">
        {JSON.stringify(conditionLd)}
      </script>
    )}

    <!-- JSON-LD: FAQPage (conditional) -->
    {faqLd && (
      <script type="application/ld+json">
        {JSON.stringify(faqLd)}
      </script>
    )}

    <!-- JSON-LD: BreadcrumbList -->
    <script type="application/ld+json">
      {JSON.stringify(breadcrumbLd)}
    </script>
  </head>

  <body class="min-h-screen">
    <main class="container mx-auto px-4 py-8">
      <article class="prose lg:prose-lg max-w-none">
        <slot />
      </article>
    </main>
  </body>
</html>




