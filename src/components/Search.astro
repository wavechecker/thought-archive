---
/**
 * Search.astro
 * Lightweight Pagefind search trigger.
 * Renders a button that opens the Pagefind UI modal on click.
 * Pagefind assets are loaded lazily on first interaction.
 */
---

<button
  type="button"
  class="pg-search-btn"
  id="search-btn"
  aria-label="Search site"
>
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="11" cy="11" r="8"></circle>
    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
  </svg>
  <span class="pg-search-btn__label">Search</span>
</button>

<div class="pg-search-overlay" id="search-overlay" hidden>
  <div class="pg-search-dialog" role="dialog" aria-label="Site search">
    <div id="search-container"></div>
    <button type="button" class="pg-search-close" id="search-close" aria-label="Close search">
      &times;
    </button>
  </div>
</div>

<script is:inline>
  (function () {
    var pagefindLoaded = false;

    function openSearch() {
      var overlay = document.getElementById("search-overlay");
      if (!overlay) return;
      overlay.hidden = false;

      if (!pagefindLoaded) {
        pagefindLoaded = true;

        // Load Pagefind UI CSS
        var link = document.createElement("link");
        link.rel = "stylesheet";
        link.href = "/pagefind/pagefind-ui.css";
        document.head.appendChild(link);

        // Load Pagefind UI JS (IIFE assigns to window.PagefindUI)
        import("/pagefind/pagefind-ui.js")
          .then(function () {
            if (!window.PagefindUI) {
              console.error("PagefindUI not found on window after loading /pagefind/pagefind-ui.js");
              return;
            }
            new window.PagefindUI({
              element: "#search-container",
              showSubResults: true,
              showImages: false,
            });
          })
          .catch(function (err) { console.error("Failed to load Pagefind UI:", err); });
      }

      // Focus the input after a brief delay
      setTimeout(function () {
        var input = overlay.querySelector(".pagefind-ui__search-input");
        if (input) input.focus();
      }, 100);
    }

    function closeSearch() {
      var overlay = document.getElementById("search-overlay");
      if (overlay) overlay.hidden = true;
    }

    // Button click
    var btn = document.getElementById("search-btn");
    if (btn) btn.addEventListener("click", openSearch);

    var closeBtn = document.getElementById("search-close");
    if (closeBtn) closeBtn.addEventListener("click", closeSearch);

    // Close on overlay background click
    var overlay = document.getElementById("search-overlay");
    if (overlay) {
      overlay.addEventListener("click", function (e) {
        if (e.target.id === "search-overlay") closeSearch();
      });
    }

    // Close on Escape
    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape") closeSearch();
    });

    // Ctrl/Cmd+K shortcut
    document.addEventListener("keydown", function (e) {
      if ((e.metaKey || e.ctrlKey) && e.key === "k") {
        e.preventDefault();
        var ov = document.getElementById("search-overlay");
        if (ov && ov.hidden) {
          openSearch();
        } else {
          closeSearch();
        }
      }
    });
  })();
</script>

<style>
  /* Search trigger button */
  .pg-search-btn {
    display: flex;
    align-items: center;
    gap: var(--pg-space-2);
    height: 2.25rem;
    padding: 0 var(--pg-space-3);
    background: transparent;
    border: 1px solid var(--pg-border);
    border-radius: var(--pg-radius-md);
    color: var(--pg-text-soft);
    font-size: var(--pg-text-sm);
    cursor: pointer;
    transition: all var(--pg-transition-fast);
  }

  .pg-search-btn:hover {
    background: var(--pg-surface-soft);
    color: var(--pg-text);
    border-color: var(--pg-border-muted);
  }

  .pg-search-btn__label {
    display: none;
  }

  @media (min-width: 640px) {
    .pg-search-btn__label {
      display: inline;
    }
  }

  /* Overlay */
  .pg-search-overlay {
    position: fixed;
    inset: 0;
    z-index: 200;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 10vh;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(2px);
  }

  /* Dialog */
  .pg-search-dialog {
    position: relative;
    width: 90vw;
    max-width: 36rem;
    max-height: 70vh;
    overflow-y: auto;
    background: var(--pg-surface);
    border: 1px solid var(--pg-border);
    border-radius: var(--pg-radius-lg, 0.75rem);
    box-shadow: 0 16px 48px rgba(0, 0, 0, 0.2);
    padding: var(--pg-space-4);
  }

  .pg-search-close {
    position: absolute;
    top: var(--pg-space-2);
    right: var(--pg-space-2);
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    color: var(--pg-text-muted);
    font-size: 1.25rem;
    cursor: pointer;
    border-radius: var(--pg-radius-md);
  }

  .pg-search-close:hover {
    background: var(--pg-surface-soft);
    color: var(--pg-text);
  }
</style>

<style is:global>
  /* Pagefind UI overrides to match site theme */
  .pagefind-ui__search-input {
    background: var(--pg-surface) !important;
    color: var(--pg-text) !important;
    border: 1px solid var(--pg-border) !important;
    border-radius: var(--pg-radius-md) !important;
    font-family: inherit !important;
  }

  .pagefind-ui__result-link {
    color: var(--pg-link) !important;
  }

  .pagefind-ui__result-excerpt {
    color: var(--pg-text-soft) !important;
  }

  .pagefind-ui {
    --pagefind-ui-scale: 0.9;
    --pagefind-ui-primary: var(--pg-link);
    --pagefind-ui-text: var(--pg-text);
    --pagefind-ui-background: var(--pg-surface);
    --pagefind-ui-border: var(--pg-border);
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-border-radius: 0.375rem;
    --pagefind-ui-font: inherit;
  }
</style>
