---
/**
 * HeroRotator.astro
 *
 * Displays featured hero content with optional rotation.
 * - No hero items: renders static fallback hero
 * - 1 hero item: renders single item without rotation controls
 * - 2+ hero items: rotates every 8s, pauses on hover
 *
 * Deterministic sorting: rotationWeight desc, then date desc, then title asc
 * No Math.random() at build time to ensure reproducible builds.
 */
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import { fmt } from "@/lib/date";

type HeroEntry = CollectionEntry<"guides"> | CollectionEntry<"posts">;

// Fetch hero-tier featured content from both collections
const allGuides = await getCollection("guides", ({ data }) =>
  data.draft !== true && data.featured === true && data.featureTier === "hero"
);
const allPosts = await getCollection("posts", ({ data }) =>
  data.draft !== true && data.featured === true && data.featureTier === "hero"
);

// Deterministic sort: weight desc → date desc → title asc
const heroEntries: HeroEntry[] = [...allGuides, ...allPosts].sort((a, b) => {
  const weightA = a.data.rotationWeight ?? 0;
  const weightB = b.data.rotationWeight ?? 0;
  if (weightB !== weightA) return weightB - weightA;

  const dateA = new Date(a.data.updatedDate ?? a.data.publishDate ?? 0).valueOf();
  const dateB = new Date(b.data.updatedDate ?? b.data.publishDate ?? 0).valueOf();
  if (dateB !== dateA) return dateB - dateA;

  return (a.data.title ?? "").localeCompare(b.data.title ?? "");
});

// Determine entry type for URL path
const guideIds = new Set(allGuides.map((g) => g.id));
function getEntryPath(entry: HeroEntry): string {
  const slug = entry.data.slug ?? entry.slug;
  return guideIds.has(entry.id) ? `/guides/${slug}` : `/posts/${slug}`;
}
function getEntryType(entry: HeroEntry): "Guide" | "Post" {
  return guideIds.has(entry.id) ? "Guide" : "Post";
}

const hasHeroes = heroEntries.length > 0;
const singleHero = heroEntries.length === 1;
const multipleHeroes = heroEntries.length > 1;
---

{/* No hero items: static fallback */}
{!hasHeroes && (
  <section class="hero-fallback py-8 px-6 bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl">
    <h2 class="text-2xl font-bold mb-2">Welcome to Patient Guide</h2>
    <p class="text-gray-700 mb-4">
      Clear, evidence-based health guides on metabolic health, chronic disease, and everyday decisions.
    </p>
    <a
      href="/guides"
      class="inline-block px-4 py-2 rounded-lg font-semibold text-white bg-gray-900 hover:bg-gray-800"
    >
      Browse Guides
    </a>
  </section>
)}

{/* Single hero: no rotation */}
{singleHero && (
  <section class="hero-single py-6">
    {heroEntries.map((entry) => {
      const path = getEntryPath(entry);
      const type = getEntryType(entry);
      const displayDate = entry.data.updatedDate ?? entry.data.publishDate;
      return (
        <a href={path} class="block group">
          <article class="p-6 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl shadow hover:shadow-md transition-shadow">
            <div class="flex items-center gap-2 mb-2">
              <span class:list={[
                "text-xs font-semibold uppercase px-2 py-0.5 rounded-full",
                type === "Post" ? "bg-blue-100 text-blue-700" : "bg-green-100 text-green-700"
              ]}>
                {type}
              </span>
              {entry.data.category && (
                <span class="text-xs px-2 py-0.5 rounded-full bg-white/60 text-gray-600">
                  {entry.data.category}
                </span>
              )}
            </div>
            <h2 class="text-2xl font-bold mb-2 group-hover:underline">{entry.data.title}</h2>
            {entry.data.description && (
              <p class="text-gray-700 mb-3 line-clamp-2">{entry.data.description}</p>
            )}
            {displayDate && (
              <span class="text-xs text-gray-500">{fmt(displayDate)}</span>
            )}
          </article>
        </a>
      );
    })}
  </section>
)}

{/* Multiple heroes: rotation with CSS + minimal JS */}
{multipleHeroes && (
  <section class="hero-rotator relative" data-hero-rotator>
    <div class="hero-slides relative overflow-hidden rounded-2xl">
      {heroEntries.map((entry, index) => {
        const path = getEntryPath(entry);
        const type = getEntryType(entry);
        const displayDate = entry.data.updatedDate ?? entry.data.publishDate;
        return (
          <a
            href={path}
            class:list={[
              "hero-slide block group absolute inset-0 transition-opacity duration-500",
              index === 0 ? "opacity-100 z-10" : "opacity-0 z-0"
            ]}
            data-slide-index={index}
          >
            <article class="p-6 h-full bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl shadow">
              <div class="flex items-center gap-2 mb-2">
                <span class:list={[
                  "text-xs font-semibold uppercase px-2 py-0.5 rounded-full",
                  type === "Post" ? "bg-blue-100 text-blue-700" : "bg-green-100 text-green-700"
                ]}>
                  {type}
                </span>
                {entry.data.category && (
                  <span class="text-xs px-2 py-0.5 rounded-full bg-white/60 text-gray-600">
                    {entry.data.category}
                  </span>
                )}
              </div>
              <h2 class="text-2xl font-bold mb-2 group-hover:underline">{entry.data.title}</h2>
              {entry.data.description && (
                <p class="text-gray-700 mb-3 line-clamp-2">{entry.data.description}</p>
              )}
              {displayDate && (
                <span class="text-xs text-gray-500">{fmt(displayDate)}</span>
              )}
            </article>
          </a>
        );
      })}
    </div>

    {/* Indicator dots */}
    <div class="hero-dots flex justify-center gap-2 mt-4">
      {heroEntries.map((_, index) => (
        <button
          type="button"
          class:list={[
            "hero-dot w-2 h-2 rounded-full transition-colors",
            index === 0 ? "bg-gray-800" : "bg-gray-300"
          ]}
          data-dot-index={index}
          aria-label={`Go to slide ${index + 1}`}
        />
      ))}
    </div>
  </section>
)}

<style>
  .hero-slides {
    min-height: 180px;
  }
  .hero-slide {
    will-change: opacity;
  }
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

{/* Client-side rotation script - only runs if multiple heroes */}
{multipleHeroes && (
  <script>
    // Self-contained IIFE to avoid global scope pollution
    // Safe for Astro view transitions (re-runs on navigation)
    (function initHeroRotator() {
      const rotator = document.querySelector("[data-hero-rotator]");
      if (!rotator) return;

      const slides = rotator.querySelectorAll<HTMLElement>("[data-slide-index]");
      const dots = rotator.querySelectorAll<HTMLElement>("[data-dot-index]");
      if (slides.length < 2) return;

      let current = 0;
      let isPaused = false;
      let intervalId: number | null = null;

      function showSlide(index: number) {
        slides.forEach((slide, i) => {
          const isActive = i === index;
          slide.classList.toggle("opacity-100", isActive);
          slide.classList.toggle("z-10", isActive);
          slide.classList.toggle("opacity-0", !isActive);
          slide.classList.toggle("z-0", !isActive);
        });
        dots.forEach((dot, i) => {
          dot.classList.toggle("bg-gray-800", i === index);
          dot.classList.toggle("bg-gray-300", i !== index);
        });
        current = index;
      }

      function nextSlide() {
        if (!isPaused) {
          showSlide((current + 1) % slides.length);
        }
      }

      function startRotation() {
        if (intervalId === null) {
          intervalId = window.setInterval(nextSlide, 8000);
        }
      }

      function stopRotation() {
        if (intervalId !== null) {
          window.clearInterval(intervalId);
          intervalId = null;
        }
      }

      // Pause on hover
      rotator.addEventListener("mouseenter", () => {
        isPaused = true;
      });
      rotator.addEventListener("mouseleave", () => {
        isPaused = false;
      });

      // Dot click navigation
      dots.forEach((dot) => {
        dot.addEventListener("click", () => {
          const index = parseInt(dot.dataset.dotIndex ?? "0", 10);
          showSlide(index);
        });
      });

      // Start rotation
      startRotation();

      // Cleanup on page navigation (Astro view transitions)
      document.addEventListener("astro:before-swap", stopRotation, { once: true });
    })();
  </script>
)}
